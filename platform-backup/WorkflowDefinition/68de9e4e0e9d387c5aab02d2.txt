{
	"appsUsed":[
		"storage_by_unifyapps"
	],
	"createdTime":1759419982346,
	"deleted":false,
	"deploymentState":{
		"deployedAt":1759661984996,
		"deployedBy":59995,
		"deployedDefinitionId":"68e24fa0a94b8359f76dd361",
		"status":"DEPLOYED",
		"version":5,
		"workflowVersion":10
	},
	"edges":[
		{
			"fromNodeId":"_EOY36",
			"priority":0,
			"skip":false,
			"toNodeId":"n_96ZBq",
			"type":"next"
		},
		{
			"fromNodeId":"n_96ZBq",
			"priority":0,
			"skip":false,
			"toNodeId":"n_6a9km",
			"type":"next"
		},
		{
			"fromNodeId":"n_6a9km",
			"priority":0,
			"skip":false,
			"toNodeId":"n_d5lsD",
			"type":"next"
		},
		{
			"fromNodeId":"n_d5lsD",
			"priority":0,
			"skip":false,
			"toNodeId":"_PaFnz",
			"type":"next"
		},
		{
			"fromNodeId":"_PaFnz",
			"name":"yes",
			"priority":0,
			"skip":false,
			"toNodeId":"_zFyJ8",
			"type":"if"
		},
		{
			"fromNodeId":"_zFyJ8",
			"priority":0,
			"skip":false,
			"toNodeId":"_ANDa3",
			"type":"next"
		},
		{
			"fromNodeId":"_PaFnz",
			"name":"no",
			"priority":0,
			"skip":false,
			"toNodeId":"_izaqB",
			"type":"next"
		},
		{
			"fromNodeId":"_izaqB",
			"priority":0,
			"skip":false,
			"toNodeId":"_Wv2bW",
			"type":"next"
		},
		{
			"fromNodeId":"_ANDa3",
			"priority":0,
			"skip":false,
			"toNodeId":"_QL5ZP",
			"type":"next"
		},
		{
			"fromNodeId":"_Wv2bW",
			"priority":0,
			"skip":false,
			"toNodeId":"_QL5ZP",
			"type":"next"
		}
	],
	"id":"68de9e4e0e9d387c5aab02d2",
	"lastModifiedBy":59995,
	"lcName":"partition size",
	"modifiedTime":1761616849580,
	"name":"partition size",
	"nodes":[
		{
			"context":{
				"appName":"callables",
				"resourceName":"callables_from_automation"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"n_nST1M@n_WOcYr@_jMFmS-1@l@3",
			"id":"_EOY36",
			"index":1,
			"inputs":{
				"result":{
					"type":"object",
					"additionalProperties":false,
					"required":[
						"criticalCount"
					],
					"properties":{
						"criticalCount":{
							"type":"number",
							"title":"Critical Count"
						}
					}
				},
				"setup":{
					"type":"object",
					"additionalProperties":false,
					"required":[
						"customerId",
						"minimumStorageSizeGB",
						"rootAutomationId",
						"rootExecutionId",
						"executionTime"
					],
					"properties":{
						"customerId":{
							"type":"integer",
							"title":"Customer Id"
						},
						"minimumStorageSizeGB":{
							"type":"number",
							"title":"Minimum Storage Size GB"
						},
						"rootAutomationId":{
							"type":"string",
							"title":"Root Automation Id"
						},
						"rootExecutionId":{
							"type":"string",
							"title":"Root Execution Id"
						},
						"executionTime":{
							"type":"number",
							"title":"Execution Time"
						}
					}
				}
			},
			"skip":false,
			"subTitle":"Callable",
			"title":"Trigger via automation",
			"trigger":{
				"type":"CALLABLE"
			},
			"type":"START"
		},
		{
			"context":{
				"appName":"callables",
				"resourceVersion":3,
				"resourceName":"callables_call_automation",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"n_nST1M@n_WOcYr@_jMFmS-1@l@3",
			"id":"n_96ZBq",
			"index":2,
			"inputs":{
				"automationId":"68b932d26607f33c4d7f0988",
				"runtimeConnections":{},
				"synchronous":true,
				"version":"-1",
				"parameters":{}
			},
			"options":{
				"bulkheadConfig":{
					"enabled":false,
					"maxLeaseTimeUnit":"SECONDS",
					"maxWaitDurationUnit":"SECONDS"
				},
				"businessHoursConfig":{
					"enabled":false,
					"waitForNextWindow":false
				},
				"cacheConfig":{
					"enabled":true,
					"timeToLive":"3600",
					"usagePolicy":"ALWAYS"
				},
				"circuitBreakerConfig":{
					"enabled":false
				},
				"disableLogging":false,
				"enabledForReExecution":false,
				"hookConfig":{
					"enabled":false,
					"postHooks":[
						
					],
					"preHooks":[
						
					]
				},
				"logConfig":{
					"enabled":false,
					"logPolicies":[
						
					]
				},
				"rateLimitConfig":{
					"enabled":false,
					"waitForNextWindow":false
				},
				"retryConfig":{
					"backOffFactor":null,
					"captureRetries":false,
					"enabled":false
				},
				"stepError":"STOP",
				"telemetryConfig":{
					"enableTelemetry":false,
					"metricConfigs":[
						
					]
				}
			},
			"skip":false,
			"subTitle":"Callable",
			"title":"Call automation",
			"type":"CALL_WORKFLOW"
		},
		{
			"context":{
				"appName":"custom_http_endpoint",
				"resourceVersion":871,
				"resourceName":"custom_http_endpoint_execute",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"n_nST1M@n_WOcYr@_jMFmS-1@l@3",
			"id":"n_6a9km",
			"index":3,
			"inputs":{
				"isAsync":false,
				"enableProxy":false,
				"requestTimeoutInSecs":-1,
				"httpMethod":"POST",
				"body":{
					"sql":"SELECT DB_NAME, TABLE_NAME, PARTITION_NAME, PARTITION_VALUE,  DATA_SIZE FROM information_schema.partitions_meta \nWHERE (\nCASE \nWHEN RIGHT(DATA_SIZE, 1) = 'B' AND RIGHT(DATA_SIZE, 2) NOT IN ('KB','MB','GB','TB') \nTHEN CAST(SUBSTRING_INDEX(DATA_SIZE, 'B', 1) AS DECIMAL(15,2))\nWHEN RIGHT(DATA_SIZE, 2) = 'KB' \nTHEN CAST(SUBSTRING_INDEX(DATA_SIZE, 'K', 1) AS DECIMAL(15,2)) * 1024\nWHEN RIGHT(DATA_SIZE, 2) = 'MB' \nTHEN CAST(SUBSTRING_INDEX(DATA_SIZE, 'M', 1) AS DECIMAL(15,2)) * 1024 * 1024\nWHEN RIGHT(DATA_SIZE, 2) = 'GB' \nTHEN CAST(SUBSTRING_INDEX(DATA_SIZE, 'G', 1) AS DECIMAL(15,2)) * 1024 * 1024 * 1024\nWHEN RIGHT(DATA_SIZE, 2) = 'TB' \nTHEN CAST(SUBSTRING_INDEX(DATA_SIZE, 'T', 1) AS DECIMAL(15,2)) * 1024 * 1024 * 1024 * 1024\nELSE 0\nEND < {{ _EOY36.outputs.minimumStorageSizeGB }} * 1024 * 1024 * 1024\n)\nORDER BY DB_NAME, TABLE_NAME,\nCASE \nWHEN RIGHT(DATA_SIZE, 1) = 'B' AND RIGHT(DATA_SIZE, 2) NOT IN ('KB','MB','GB','TB') \nTHEN CAST(SUBSTRING_INDEX(DATA_SIZE, 'B', 1) AS DECIMAL(15,2))\nWHEN RIGHT(DATA_SIZE, 2) = 'KB' \nTHEN CAST(SUBSTRING_INDEX(DATA_SIZE, 'K', 1) AS DECIMAL(15,2)) * 1024\nWHEN RIGHT(DATA_SIZE, 2) = 'MB' \nTHEN CAST(SUBSTRING_INDEX(DATA_SIZE, 'M', 1) AS DECIMAL(15,2)) * 1024 * 1024\nWHEN RIGHT(DATA_SIZE, 2) = 'GB' \nTHEN CAST(SUBSTRING_INDEX(DATA_SIZE, 'G', 1) AS DECIMAL(15,2)) * 1024 * 1024 * 1024\nWHEN RIGHT(DATA_SIZE, 2) = 'TB' \nTHEN CAST(SUBSTRING_INDEX(DATA_SIZE, 'T', 1) AS DECIMAL(15,2)) * 1024 * 1024 * 1024 * 1024\nELSE 0\nEND DESC;"
				},
				"connectionType":"DIRECT",
				"sslVerify":false,
				"path":"/internal/sql-report/runSQL/query/{{ _EOY36.outputs.customerId }}",
				"responseSchema":{
					"type":"object",
					"additionalProperties":false,
					"properties":{
						"objects":{
							"type":"array",
							"items":{
								"type":"object",
								"properties":{
									"DATA_SIZE":{
										"type":"string",
										"title":"DATA SIZE"
									},
									"PARTITION_NAME":{
										"type":"string",
										"title":"PARTITION NAME"
									},
									"TABLE_NAME":{
										"type":"string",
										"title":"TABLE NAME"
									},
									"DB_NAME":{
										"type":"string",
										"title":"DB NAME"
									},
									"PARTITION_VALUE":{
										"type":"string",
										"title":"PARTITION VALUE"
									}
								},
								"additionalProperties":false,
								"required":[
									"DATA_SIZE",
									"PARTITION_NAME",
									"TABLE_NAME",
									"DB_NAME",
									"PARTITION_VALUE"
								]
							},
							"title":"objects"
						}
					}
				},
				"baseUrl":"http://internal-global-svc:80",
				"httpVersion":"HTTP_2",
				"bodySchema":{
					"type":"object",
					"additionalProperties":false,
					"required":[],
					"properties":{
						"sql":{
							"type":"string",
							"title":"Sql"
						}
					}
				},
				"queryParamsList":[
					{
						"key":"sqlResourceType",
						"value":"PLATFORM"
					}
				],
				"responseContentType":"application/json",
				"followRedirects":"NORMAL",
				"authType":"CUSTOM",
				"requestContentType":"application/json",
				"ignoreTrailingSlashes":false,
				"certificateType":"CERT_STRING"
			},
			"skip":false,
			"subTitle":"Get Partitions with size < threshold",
			"title":"Execute REST request",
			"type":"ACTION"
		},
		{
			"additional":{
				"xsdSchemaConfig":{
					"root":{}
				}
			},
			"context":{
				"appName":"code_by_unifyapps",
				"resourceVersion":111,
				"resourceName":"code_by_unifyapps_groovy",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"n_nST1M@n_WOcYr@_jMFmS-1@l@3",
			"id":"n_d5lsD",
			"index":4,
			"inputs":{
				"output":{
					"type":"object",
					"additionalProperties":false,
					"properties":{
						"inputs":{
							"type":"object",
							"properties":{
								"minimumStorageSizeGB":{
									"type":"number",
									"title":"minimumStorageSizeGB"
								}
							},
							"title":"inputs",
							"additionalProperties":false,
							"required":[]
						},
						"slackMessage":{
							"type":"string",
							"title":"slackMessage"
						},
						"outputs":{
							"type":"object",
							"properties":{
								"alertPartitions":{
									"type":"array",
									"items":{
										"type":"object",
										"properties":{
											"DB_NAME":{
												"type":"string",
												"title":"DB_NAME"
											},
											"TABLE_NAME":{
												"type":"string",
												"title":"TABLE_NAME"
											},
											"partitions":{
												"type":"array",
												"items":{
													"type":"object",
													"properties":{
														"PARTITION_NAME":{
															"type":"string",
															"title":"PARTITION_NAME"
														},
														"DATA_SIZE":{
															"type":"string",
															"title":"DATA_SIZE"
														}
													},
													"additionalProperties":false
												},
												"title":"partitions"
											}
										},
										"additionalProperties":false
									},
									"title":"alertPartitions"
								}
							},
							"title":"outputs",
							"additionalProperties":false
						}
					}
				},
				"input":{
					"type":"object",
					"additionalProperties":false,
					"required":[
						"partitions",
						"minimumStorageSize",
						"rootAutomationId",
						"rootExecutionId"
					],
					"properties":{
						"partitions":{
							"type":"array",
							"items":{
								"type":"object",
								"properties":{},
								"additionalProperties":false
							},
							"title":"Partitions"
						},
						"minimumStorageSize":{
							"type":"number",
							"title":"Minimum Storage Size"
						},
						"rootAutomationId":{
							"type":"string",
							"title":"Root Automation Id"
						},
						"rootExecutionId":{
							"type":"string",
							"title":"Root Execution Id"
						}
					}
				},
				"code":"if (!binding.hasVariable('partitions')) {\n    return [\"inputs\": [\"minimumStorageSizeGB\": minimumStorageSize], \"slackMessage\": \"\", \"outputs\": [\"alertPartitions\": []]]\n}\n\ndef slackMessage = new StringBuilder()\nslackMessage << \"\\n\\n\"\n\ndef items = []\ndef now = System.currentTimeMillis()\n\ndef dbTable = [] as Set\n\npartitions.each { partition ->\n    def pv = partition.PARTITION_VALUE\n    long start\n    long end\n    if (pv.contains(\"DATETIME\")) {\n        def matchesDate = (pv =~ /\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}/)\n        if (matchesDate.size() >= 2) {\n            if (matchesDate[0] == \"0000-00-00 00:00:00\") {\n                // This is an invalid or uninitialized partition, skip it\n            } else {\n                start = java.sql.Timestamp.valueOf(matchesDate[0]).time\n                end = java.sql.Timestamp.valueOf(matchesDate[1]).time\n            }\n        } \n    } else {\n        def matchesMillis = (pv =~ /\\d{13}/)\n        if (matchesMillis.size() >= 2) {\n            start = matchesMillis[0] as Long\n            end = matchesMillis[1] as Long\n        }\n    }\n    if (start != null && end != null && now >= start && now < end) {\n        if (dbTable.contains(partition.DB_NAME) && dbTable.contains(partition.TABLE_NAME)) {\n            items.last()[\"partitions\"].add([PARTITION_NAME: partition.PARTITION_NAME, DATA_SIZE: partition.DATA_SIZE])\n        } else {\n            items << [DB_NAME: partition.DB_NAME, TABLE_NAME: partition.TABLE_NAME, partitions: [[PARTITION_NAME: partition.PARTITION_NAME, DATA_SIZE: partition.DATA_SIZE]]]\n            dbTable = [partition.DB_NAME, partition.TABLE_NAME] as Set\n        }\n    }\n}\n\nitems.each { partition ->\n    slackMessage << \"*DB:* `${partition.DB_NAME}`\\n\"\n    slackMessage << \"*Table:* `${partition.TABLE_NAME}`\\n\"\n    for (part in partition.partitions) {\n        slackMessage << \"*PartitionName:* `${part.PARTITION_NAME}` *Size:* `${part.DATA_SIZE}`\\n\"\n    }\n    slackMessage << \"-----------------------------\\n\"\n}\n\nif (partitions.size() > 100) {\n  slackMessage = \"• Message length is too large to send. Please check details in rootAutomationId: \" + rootAutomationId + \" and rootExecutionId: \" + rootExecutionId\n}\n\nreturn [\"inputs\": [minimumStorageSizeGB: minimumStorageSize], \"slackMessage\": slackMessage,  \"outputs\":[\"alertPartitions\": items]]",
				"compile_static":false,
				"captureStdOutput":false,
				"parameters":{
					"minimumStorageSize":"{{ _EOY36.outputs.minimumStorageSizeGB }}",
					"rootAutomationId":"{{ _EOY36.outputs.rootAutomationId }}",
					"rootExecutionId":"{{ _EOY36.outputs.rootExecutionId }}",
					"partitions":{
						"source":"{{ n_6a9km.outputs.result.objects }}",
						"ua:type":"mappedArray",
						"items":"{{ n_6a9km.outputs.result.objects[0] }}"
					}
				}
			},
			"skip":false,
			"subTitle":"Generate Slack message",
			"title":"Execute Groovy code",
			"type":"ACTION"
		},
		{
			"context":{
				"appName":"if_else",
				"resourceVersion":767,
				"resourceName":"if_else_condition",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"n_nST1M@n_WOcYr@_jMFmS-1@l@3",
			"id":"_PaFnz",
			"index":5,
			"inputs":{
				"filters":[
					{
						"property":"=LEN({{ _DKDTU.outputs.result.outputs.criticalSizeRoutineLoads }})",
						"filter":{
							"operator":"GT",
							"value":"0"
						}
					}
				],
				"operator":"AND"
			},
			"skip":false,
			"subTitle":"Condition",
			"title":"Condition",
			"type":"IF_ELSE"
		},
		{
			"additional":{
				"visibleOptionalFields":[
					"root.record.steps.inputs",
					"root.record.steps.outputs"
				]
			},
			"context":{
				"appName":"storage_by_unifyapps",
				"resourceVersion":3226,
				"resourceName":"storage_by_unifyapps_create_record",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"_PaFnz@n_nST1M@n_WOcYr@_jMFmS-1@l@3@y",
			"id":"_zFyJ8",
			"index":6,
			"inputs":{
				"writeThroughSessionVariables":false,
				"object_type":"infra_alert_steps",
				"skipIfBlank":false,
				"record":{
					"alertType":"starrocks_table_health",
					"rootAutomationId":"{{ _EOY36.outputs.rootAutomationId }}",
					"rootExecutionId":"{{ _EOY36.outputs.rootExecutionId }}",
					"executedAt":"{{ _EOY36.outputs.executionTime }}",
					"alertCategory":"starrocks",
					"alertSubType":"routine_load_parition_sizes",
					"stepsOrder":7,
					"summary":"Check whether the partition of a routine load has a small data size",
					"steps":{
						"inputs":"{{ n_d5lsD.outputs.result.inputs }}",
						"outputs":"{{ n_d5lsD.outputs.result.outputs }}"
					},
					"status":"CRITICAL",
					"stepDescription":"Check whether each partition of a routine load has < {{ _EOY36.outputs.minimumStorageSizeGB }}GB storage, which is too small",
					"resolved":false
				}
			},
			"skip":false,
			"subTitle":"Create Alert Step",
			"title":"Create record",
			"type":"ACTION"
		},
		{
			"context":{
				"appName":"callables",
				"resourceVersion":3,
				"resourceName":"callables_call_automation",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"_PaFnz@n_nST1M@n_WOcYr@_jMFmS-1@l@3@y",
			"id":"_ANDa3",
			"index":7,
			"inputs":{
				"automationId":"68721bd4feea003f6a9cb688",
				"runtimeConnections":{},
				"synchronous":false,
				"version":"-1",
				"parameters":{
					"env":"{{ n_96ZBq.outputs.env }}",
					"alertCategory":"starrocks",
					"alertType":"starrocks_table_health",
					"alertTitle":"🚨 Small Data Size in Routine Load Partitions (<{{ _EOY36.outputs.minimumStorageSizeGB }}GB)",
					"alertDescription":"For customer {{ _EOY36.outputs.customerId }}, the following routine load partitions have data size < {{ _EOY36.outputs.minimumStorageSizeGB }}GB:\n{{ n_d5lsD.outputs.result.slackMessage }}"
				}
			},
			"skip":false,
			"subTitle":"Callable",
			"title":"Call automation",
			"type":"CALL_WORKFLOW"
		},
		{
			"additional":{
				"visibleOptionalFields":[
					"root.record.steps.inputs",
					"root.record.steps.outputs"
				]
			},
			"context":{
				"appName":"storage_by_unifyapps",
				"resourceVersion":3226,
				"resourceName":"storage_by_unifyapps_create_record",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"_PaFnz@n_nST1M@n_WOcYr@_jMFmS-1@l@3@n",
			"id":"_izaqB",
			"index":8,
			"inputs":{
				"writeThroughSessionVariables":false,
				"object_type":"infra_alert_steps",
				"skipIfBlank":false,
				"record":{
					"alertType":"starrocks_table_health",
					"rootAutomationId":"{{ _EOY36.outputs.rootAutomationId }}",
					"rootExecutionId":"{{ _EOY36.outputs.rootExecutionId }}",
					"executedAt":"{{ _EOY36.outputs.executionTime }}",
					"alertCategory":"starrocks",
					"alertSubType":"routine_load_parition_sizes",
					"stepsOrder":7,
					"summary":"Check whether the partition of a routine load has a small data size",
					"steps":{
						"inputs":"{{ n_d5lsD.outputs.result.inputs }}",
						"outputs":"{{ n_d5lsD.outputs.result.outputs }}"
					},
					"status":"OK",
					"stepDescription":"Check whether each partition of a routine load has < {{ _EOY36.outputs.minimumStorageSizeGB }}GB storage, which is too small",
					"resolved":true
				}
			},
			"skip":false,
			"subTitle":"Create Alert Step",
			"title":"Create record",
			"type":"ACTION"
		},
		{
			"context":{
				"appName":"callables",
				"resourceVersion":3,
				"resourceName":"callables_call_automation",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"_PaFnz@n_nST1M@n_WOcYr@_jMFmS-1@l@3@n",
			"id":"_Wv2bW",
			"index":9,
			"inputs":{
				"automationId":"68721bd4feea003f6a9cb688",
				"runtimeConnections":{},
				"synchronous":false,
				"version":"-1",
				"parameters":{
					"env":"{{ n_96ZBq.outputs.env }}",
					"alertCategory":"starrocks",
					"alertType":"starrocks_table_health",
					"alertTitle":"🚨 Small Data Size in Routine Load Partitions (<{{ _EOY36.outputs.minimumStorageSizeGB }}GB)",
					"alertDescription":"For customer {{ _EOY36.outputs.customerId }}, the following routine load partitions have data size < {{ _EOY36.outputs.minimumStorageSizeGB }}GB:\n{{ n_d5lsD.outputs.result.slackMessage }}"
				}
			},
			"skip":false,
			"subTitle":"Callable",
			"title":"Call automation",
			"type":"CALL_WORKFLOW"
		},
		{
			"context":{
				"appName":"callables",
				"resourceName":"callables_return_to_automation",
				"type":"APPLICATION"
			},
			"debug":false,
			"dirty":true,
			"fallbackMode":"STOP",
			"groupId":"n_nST1M@n_WOcYr@_jMFmS-1@l@3",
			"id":"_QL5ZP",
			"index":10,
			"inputs":{
				"result":{
					"criticalCount":"=LEN({{ n_d5lsD.outputs.result.outputs.alertPartitions }})"
				}
			},
			"skip":false,
			"subTitle":"Callable",
			"title":"Respond to automation",
			"type":"STOP"
		}
	],
	"ownerUserId":59995,
	"schemaReferences":[
		
	],
	"settings":{
		"enableNodeLevelLogging":true,
		"enableRunLogging":true,
		"enableVariableLogging":true,
		"route":{
			"default":false,
			"tierName":"global"
		}
	},
	"standard":false,
	"tags":[
		
	],
	"version":11
}